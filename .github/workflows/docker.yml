# Build & Publish GitHub Container Registry (GHCR) Images
name: Build Geant4 Images
permissions:
  contents: read
  packages: write

# default varsions. This is overwritten by distros_tags.sh
env:
  ROOT_TAG: v6-36-04      # default ROOT tag
  MESON_TAG: 1.9.0        # default Meson version
  NOVNC_TAG: v1.6.0       # default noVNC tag
  GEANT4_TAG: 11.4.0      # default geant4 tag

concurrency:
  group: geant4-images-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]   # publish on main updates
    tags: [ 'v*' ]       # also publish on version tags
  pull_request:          # PRs: build only (no push)

jobs:
  overview:
    if: ${{ github.event_name != 'pull_request' }}
    name: Workflow Overview
    needs: [ discover ]
    runs-on: ubuntu-latest
    steps:
      - name: Write overview
        shell: bash
        run: |
          : "${GITHUB_STEP_SUMMARY:=$RUNNER_TEMP/summary.md}"
          {
            echo "# Geant4 Images — Overview"
            echo "Repository: [g4install images](https://github.com/gemc/g4install/pkgs/container/g4install)"
            echo "Except for archlinux (amd64-only), all images are built for both the *amd64* and *arm64* architectures."
            echo ""
            echo "## Component versions"
            echo ""
            echo "| Geant4 | ROOT | Meson | noVNC |"
            echo "|---|---|---|---|"

            MATRIX='${{ needs.discover.outputs.matrix_build }}'
            echo "$MATRIX" | jq -r \
              --arg ROOT   "${ROOT_TAG}" \
              --arg MESON  "${MESON_TAG}" \
              --arg NOVNC  "${NOVNC_TAG}" \
              --arg GEANT4 "${GEANT4_TAG}" \
              '
              (if type=="object" and has("include") then .include else . end)
              | map({
                  geant4: (.geant4_tag // $GEANT4),
                  root:   (.root_tag   // $ROOT),
                  meson:  (.meson_tag  // $MESON),
                  novnc:  (.novnc_tag  // $NOVNC)
                })
              | unique
              | sort_by(.geant4,.root,.meson,.novnc)
              | .[]
              | "| \(.geant4) | \(.root) | \(.meson) | \(.novnc) |"
              '
            echo ""
            echo ""
            echo "Set these convenience variables for the interactive use below (choose your own password)"
            echo '```bash'
            echo 'VPORTS=(-p 6080:6080 -p 5900:5900)'
            echo 'VNC_PASS=(-e X11VNC_PASSWORD=change-me)'
            echo 'VNC_BIND=(-e VNC_BIND=0.0.0.0)'
            echo 'GEO_FLAGS=(-e GEOMETRY=1920x1200)'
            echo '```'
            echo ""
            echo "If your arch is arm64 and want to use the archlinux image, add this to *all command lines*:"
            echo '```bash'
            echo '--platform=linux/amd64'
            echo '```'
            echo "---"
          } >> "$GITHUB_STEP_SUMMARY"

  discover:
    if: ${{ github.event_name != 'pull_request' }}
    name: Create Job Matrices
    runs-on: ubuntu-latest
    outputs:
      matrix_build: ${{ steps.scan.outputs.matrix_build }}
      matrix_manifest: ${{ steps.scan.outputs.matrix_manifest }}
      image: ${{ steps.scan.outputs.image }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - id: scan
        name: Build matrix
        run: ci/distros_tags.sh

  # arch build jobs
  # uses matrix_build
  build_arch:
    if: ${{ github.event_name != 'pull_request' }}
    name: ${{ matrix.arch }} ${{ matrix.geant4_tag }} ${{ matrix.image }}:${{ matrix.image_tag }}
    needs: [ overview, discover ]
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix_build) }}

    env:
      CACHE_REF: type=registry,ref=${{ needs.discover.outputs.image }}:cache-${{ matrix.arch }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        name: Docker metadata (base tag)
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.discover.outputs.image }}
          tags: |
            type=raw,value=${{ format('{0}-{1}-{2}', matrix.geant4_tag, matrix.image, matrix.image_tag) }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.description=Geant4 ${{ matrix.geant4_tag }} on ${{ matrix.image }}:${{ matrix.image_tag }} (${{ matrix.arch }})

      - name: Generate Dockerfile
        run: |
          python3 ci/dockerfile_creator.py \
          -i "${{ matrix.image }}" \
          -t "${{ matrix.image_tag }}" \
          --root-version "${{ matrix.root_tag || env.ROOT_TAG  }}" \
          --meson-version "${{ matrix.meson_tag || env.MESON_TAG  }}" \
          --novnc-version "${{ matrix.novnc_tag || env.NOVNC_TAG }}" \
          --geant4-version "${{ matrix.geant4_tag || env.GEANT4_TAG }}" \
          > Dockerfile.generated
          cat Dockerfile.generated

      # later pass it in the step below so that it's executed for every commit
      - name: Get upstream commit
        shell: bash
        run: echo "UPSTREAM_REV=$(git ls-remote https://github.com/gemc/g4install HEAD | cut -f1)" >> $GITHUB_ENV

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          # pull ensure we have the latest base image
          pull: true
          # force a full rebuild regardless of any local cache from previous workflow runs
          no-cache: true
          build-args: |
            UPSTREAM_REV=${{ env.UPSTREAM_REV }}
          context: .
          file: ./Dockerfile.generated
          platforms: ${{ matrix.platform }}
          push: true
          # Add suffix to the arch-specific image tag
          tags: ${{ steps.meta.outputs.tags }}${{ matrix.suffix }}
          labels: ${{ steps.meta.outputs.labels }}
          # build layers are imported from a previously exported BuildKit cache
          # cache-from: ${{ env.CACHE_REF }}
          # publishes the BuildKit cache to your container registry under that tag
          cache-to:   ${{ env.CACHE_REF }},mode=max


  # Manifest stitch
  # uses matrix_manifest so it's not repeated for each arch
  # docker buildx imagetools create: assembles an OCI manifest list
  # from already-pushed per-arch image tags.
  manifest:
    if: ${{ github.event_name != 'pull_request' }}
    name: Manifest ${{ matrix.geant4_tag }} ${{ matrix.image }}:${{ matrix.image_tag }}
    needs: [ build_arch, discover ]
    runs-on: ubuntu-latest
    # If arm64 was skipped (e.g., archlinux), still publish amd64-only manifest.
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix_manifest) }}
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - id: meta
        name: Docker metadata (base tag)
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.discover.outputs.image }}
          tags: |
            type=raw,value=${{ format('{0}-{1}-{2}', matrix.geant4_tag, matrix.image, matrix.image_tag) }}

      - name: Create multi-arch manifest
        shell: bash
        run: |
          BASE_TAG="${{ steps.meta.outputs.tags }}"
          AMD_TAG="${BASE_TAG}-amd64"
          ARM_TAG="${BASE_TAG}-arm64"

          # If the arm64 build was skipped (e.g., archlinux), only include amd64
          if docker buildx imagetools inspect "$ARM_TAG" >/dev/null 2>&1; then
            docker buildx imagetools create -t "$BASE_TAG" "$AMD_TAG" "$ARM_TAG"
          else
            docker buildx imagetools create -t "$BASE_TAG" "$AMD_TAG"
          fi

      - name: Summary (manifest)
        shell: bash
        env:
          IMAGE: ${{ needs.discover.outputs.image }}
          TAG: ${{ format('{0}-{1}-{2}', matrix.geant4_tag, matrix.image, matrix.image_tag) }}
        run: |
          SUMMARY_FILE="${GITHUB_STEP_SUMMARY:-$RUNNER_TEMP/manifest_summary.md}"
          echo "MANIFEST_SUMMARY_FILE=$SUMMARY_FILE" >> "$GITHUB_ENV"
          {
            echo "## \`${IMAGE}:${TAG}\`"
            echo ""
            echo "Includes:"
            if docker buildx imagetools inspect "${IMAGE}:${TAG}-amd64" >/dev/null 2>&1; then echo "- amd64"; fi
            if docker buildx imagetools inspect "${IMAGE}:${TAG}-arm64" >/dev/null 2>&1; then echo "- arm64"; else echo "- no arm64. Run with --platform=linux/amd64 in arm64 CPUs.  On MacOs you may need to use Rosetta for correct terminal emulation."; fi
            echo ""
            echo "### Pull"
            echo '```bash'
            echo "docker pull ${IMAGE}:${TAG}"
            echo '```'
            echo ""
            echo "### Run in batch mode"
            echo '```bash'
            echo "docker run --rm -it ${IMAGE}:${TAG} bash -li"
            echo '```'
            echo ""
            echo "### Run in graphical mode with VNC/noVNC"
            echo "_VNC → localhost:5900 (password: change-me)_"
            echo "_noVNC → http://localhost:6080/vnc.html (password: change-me)_"
            echo '```bash'
            echo "docker run --rm -it \$VPORTS \$VNC_BIND \$VNC_PASS \$GEO_FLAGS ${IMAGE}:${TAG}"
            echo '```'
          } >> "$SUMMARY_FILE"

          # Also save a copy inside the workspace for artifact upload
          mkdir -p "$GITHUB_WORKSPACE/summaries"
          cp "$SUMMARY_FILE" "$GITHUB_WORKSPACE/summaries/summary-${{ matrix.geant4_tag }}-${{ matrix.image }}-${{ matrix.image_tag }}-${{ job.status }}.md" || true
          echo "Wrote $GITHUB_WORKSPACE/summaries/summary-${{ matrix.geant4_tag }}-${{ matrix.image }}-${{ matrix.image_tag }}.md"
          ls -l "$GITHUB_WORKSPACE/summaries"

      - name: Upload summary artifact (manifest)
        uses: actions/upload-artifact@v4
        with:
          name: summary-${{ matrix.geant4_tag }}-${{ matrix.image }}-${{ matrix.image_tag }}-manifest
          path: ${{ env.MANIFEST_SUMMARY_FILE }}
          if-no-files-found: ignore
