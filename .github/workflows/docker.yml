# Build & Publish GitHub Container Registry (GHCR) Images
name: Build Geant4 Images

on:
  push:
    branches: [ main ]   # publish on main updates
    tags: [ 'v*' ]       # also publish on version tags
  pull_request:          # PRs: build only (no push)

concurrency:
  group: ghcr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  discover:
    name: Discover Dockerfiles
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.scan.outputs.matrix }}
      image: ${{ steps.scan.outputs.image }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ci/distros_tags.sh must echo a JSON matrix to $GITHUB_OUTPUT:
      #   echo "matrix=<JSON>" >> $GITHUB_OUTPUT
      # and the base image name (no tag) like "ghcr.io/<owner>/geant4":
      #   echo "image=ghcr.io/<owner>/geant4" >> $GITHUB_OUTPUT
      - id: scan
        name: Build matrix
        run: ci/distros_tags.sh

  build:
    name: Build ${{ matrix.geant4_tag }} on ${{ matrix.docker_from }}
    needs: discover
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        name: Generate tags & labels
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.discover.outputs.image }}
          tags: |
            # Single canonical tag: geant4-<tag>-<base>
            type=raw,value=${{ matrix.geant4_tag }}-${{ replace(matrix.docker_from, ':', '-') }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.description=Geant4 image (${{ matrix.geant4_tag }} on ${{ matrix.image }}) ${{ matrix.image_tag }}

      # Generate a Dockerfile using your python script, passing the FULL base image
      - name: Generate Dockerfile
        run: |
          python3 ci/dockerfile_creator.py \
          -i "${{ matrix.image }}" \
          -t "${{ matrix.image_tag }}" 
          --root-version "${{ matrix.root_tag || '6.36.04' }}" \
          --meson-version "${{ matrix.meson_tag || '1.9.0' }}" \
          --novnc-version "${{ matrix.novnc_tag || 'v1.6.0' }}" \
          > Dockerfile.generated
          echo "Generated Dockerfile:"
          sed -n '1,60p' Dockerfile.generated

      - name: Choose platforms for this item
        id: plats
        shell: bash
        run: |
          PLATS="linux/amd64,linux/arm64"
          case "${{ matrix.docker_from }}" in
            archlinux:*) PLATS="linux/amd64" ;;  # Arch image is amd64-only
          esac
          echo "plats=$PLATS" >> "$GITHUB_OUTPUT"

      # Multi-arch when pushing; single-arch and load locally on PRs
      - name: Build and Push (release/merge)
        if: ${{ github.event_name != 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.generated
          platforms: ${{ steps.plats.outputs.plats }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ needs.discover.outputs.image }}:cache
          cache-to: type=registry,ref=${{ needs.discover.outputs.image }}:cache,mode=max


      - name: Summarize image reference
        shell: bash
        env:
          IMAGE: ${{ needs.discover.outputs.image }}
          TAG="${{ matrix.geant4_tag }}-$(echo '${{ matrix.docker_from }}' | tr ':' '-')"
          PUSHED: ${{ github.event_name != 'pull_request' }}
          IS_ARCH: ${{ startsWith(matrix.docker_from, 'archlinux:') }}
        run: |
          # prepare summary target safely
          if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
            mkdir -p "$(dirname "$GITHUB_STEP_SUMMARY")"
            SUMMARY_OUT="$GITHUB_STEP_SUMMARY"
          else
            SUMMARY_OUT="$RUNNER_TEMP/step_summary.md"
            mkdir -p "$(dirname "$SUMMARY_OUT")"
            echo "GITHUB_STEP_SUMMARY not set; writing to $SUMMARY_OUT"
          fi
          
          PLATFORM_HINT="--platform=linux/amd64"
          
          {
            echo "## Docker Image"
            echo ""
            echo "**Tag:** \`${IMAGE}:${TAG}\`"
          
            if [ "$PUSHED" = "true" ]; then
              echo ""
              echo "### Pull"
              echo '```bash'
              echo "docker pull ${IMAGE}:${TAG}"
              echo '```'
            else
              echo ""
              echo "_PR build (image not pushed). Loaded locally on the runner with tags:_"
              echo '```'
              printf '%s\n' "${{ steps.meta.outputs.tags }}"
              echo '```'
            fi
          
            echo ""
            echo "### Run (interactive shell)"
            echo '```bash'
            if [ "$IS_ARCH" = "true" ]; then
              echo "docker run --rm -it ${PLATFORM_HINT} ${IMAGE}:${TAG} bash"
            else
              echo "docker run --rm -it ${IMAGE}:${TAG} bash"
            fi
            echo '```'
          
            echo ""
            echo "### Run with browser (noVNC)"
            echo "Open **http://localhost:6080** after starting."
            echo ""
            echo "**Default geometry:** \`1280x800\` (override with \`-e GEOMETRY=WIDTHxHEIGHT\`)."
            echo ""
            echo '**Start (same-arch host):**'
            echo '```bash'
            if [ "$IS_ARCH" = "true" ]; then
              echo "docker run --rm -p 6080:6080 ${PLATFORM_HINT} ${IMAGE}:${TAG}"
            else
              echo "docker run --rm -p 6080:6080 ${IMAGE}:${TAG}"
            fi
            echo '```'
            echo ""
            echo '**Start with custom resolution:**'
            echo '```bash'
            if [ "$IS_ARCH" = "true" ]; then
              echo "docker run --rm -p 6080:6080 -e GEOMETRY=1600x900 ${PLATFORM_HINT} ${IMAGE}:${TAG}"
            else
              echo "docker run --rm -p 6080:6080 -e GEOMETRY=1600x900 ${IMAGE}:${TAG}"
            fi
            echo '```'
          
            echo ""
            echo "### Notes by distro"
            echo "- **Ubuntu/Debian/Fedora/AlmaLinux**: Xvfb + x11vnc + packaged noVNC."
            echo "- **Arch Linux**: Xvfb + x0vncserver (TigerVNC) + noVNC from /opt (amd64-only â†’ use \`${PLATFORM_HINT}\` on arm64)."
          } >> "$SUMMARY_OUT"
          
          echo "Summary written to: $SUMMARY_OUT"
